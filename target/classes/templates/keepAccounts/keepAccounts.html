<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Financial Management - 记账</title>
    <link rel="stylesheet" th:href="@{/css/layui.css}" media="all">
    <link rel="stylesheet" th:href="@{/css/common.css}" media="all">
    <style>
        .layui-form .layui-input-inline {
            width: 120px;
        }

        .layui-form-label {
            width: 100px;
        }

        #form-search .layui-form-label {
            width: 80px;
        }

        #account-total-list .amount {
            font-size: 16px;
        }

        #account-total-list .separator {
            color: lightgrey;
            margin-left: 12px;
            margin-right: 12px;
        }
    </style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <!-- 头部区域（菜单栏） -->
    <div th:replace="/common/header::header-div"></div>

    <!-- 左侧导航区域（账本） -->
    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll">
            <!-- 左侧导航区域（账本） -->
            <ul class="layui-nav layui-nav-tree" lay-filter="all">
                <li class="layui-nav-item layui-nav-itemed" id="menu">
                    <a href="javascript:">
                        <i class="layui-icon layui-icon-read" style="font-size: 15px; margin-right: 15px"></i>
                        所有账本
                        <i class="layui-icon layui-icon-down layui-nav-more"></i>
                    </a>
                    <dl class="layui-nav-child" id="dl-account-book">
                        <dd id="accountBook">
                            <a href="javascript:">
                                <i class="layui-icon layui-icon-addition" style="font-size: 15px"></i>
                                添加账本
                                <i style="margin-right: 35px"></i>
                            </a>
                        </dd>
                    </dl>
                </li>
            </ul>
        </div>
    </div>

    <!--  内容主体 body  -->
    <div class="layui-body" style="margin: 15px">
        <!--   选项卡  -->
        <div class="layui-tab layui-tab-brief" lay-filter="keepAccounts" style="margin: 0; background-color: white">
            <ul class="layui-tab-title">
                <li class="layui-this" lay-id="支出">支出</li>
                <li lay-id="收入">收入</li>
            </ul>
            <!--  选项卡 tab 容器 -->
            <div class="layui-tab-content" style="margin-bottom: -25px">
                <!-- 选项卡面板（支出） -->
                <div class="layui-tab-item layui-show">
                    <div style="height: 160px; ">
                        <!-- 账本头像 -->
                        <div style="float:left; margin-left: 70px; width: 140px; height: 140px">
                            <img width="140" height="140" class="accountBookHeaderImg" alt="" src="">
                            <div style="height: 38px;">
                                <a href="javascript:" title="上传头像"><i class="layui-icon" style="color: #009688"
                                                                      id="accountBookHeader">&#xe67c;</i></a>
                            </div>
                        </div>

                        <!-- 记账面板-->
                        <div class="layui-form" style="float:right; margin-right: 120px;">
                            <div class="layui-form-item">
                                <input type="hidden" name="in_ex_status" value="支">
                                <label class="layui-form-label" for="first-expense-category">
                                    一级分类：
                                    <a href="javascript:" class="add-category" title="添加分类">
                                        <i class="layui-icon layui-icon-addition"
                                           style="font-size: 15px; margin: 0"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <select name="first_expense_category" id="first-expense-category"
                                            lay-filter="first_expense_category" class="first-category">
                                        <option>一级分类</option>
                                    </select>
                                </div>

                                <label class="layui-form-label" for="second-expense-category">
                                    二级分类：
                                    <a href="javascript:" class="add-category" title="添加分类"><i
                                            class="layui-icon layui-icon-addition"
                                            style="font-size: 15px; margin: 0"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <select name="second_category_name" id="second-expense-category"
                                            class="second-category">
                                        <option>二级分类</option>
                                    </select>
                                </div>

                                <label class="layui-form-label" for="account-type">金融账户：
                                    <a href="javascript:" title="添加金融账户">
                                        <i class="layui-icon layui-icon-addition"
                                           style="font-size: 15px; margin: 0"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <select name="account_type_name" id="account-type" class="account-type">
                                        <option>金融账户</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label" for="date">
                                    日期时间：
                                    <a><i class="layui-icon" style="font-size: 15px; margin-left: 15px"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <input type="text" class="layui-input date" id="date" name="dateConverted"
                                           style="width: 150px">
                                </div>

                                <label class="layui-form-label" for="amount">
                                    金额明细：
                                    <a><i class="layui-icon" style="font-size: 15px; margin-left: 15px"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <input type="text" name="amount" required lay-verify="amount"
                                           placeholder="金额明细" autocomplete="off" class="layui-input amount" id="amount">
                                </div>

                                <label class="layui-form-label" for="category-template">
                                    分类模板：
                                    <a href="javascript:" class="add-category-template" title="添加分类模板">
                                        <i class="layui-icon layui-icon-addition"
                                           style="font-size: 15px; margin: 0"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <select id="category-template" name="categoryTemplate"
                                            lay-filter="categoryTemplate" class="category-template">
                                        <option>分类模板</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label" for="remarks">备注：
                                    <a><i class="layui-icon"
                                          style="font-size: 15px; margin-left: 15px"></i></a></label>
                                <div class="layui-input-inline" style="width: 380px">
                                    <input type="text" name="remarks" id="remarks" placeholder="备注" autocomplete="off"
                                           class="layui-input" width="380px" lay-verify="remarks">
                                </div>

                                <button class="layui-btn" lay-submit lay-filter="addAccountCurrent"
                                        style="margin-left: 26px">立即保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 选项卡面板（收入）-->
                <div class="layui-tab-item">
                    <div style="height: 160px; ">
                        <!-- 账本头像 -->
                        <div style="float:left; margin-left: 70px; width: 140px; height: 140px">
                            <img width="140" height="140" class="accountBookHeaderImg" alt="" src="">
                            <div style="height: 38px;">
                                <a href="javascript:" title="上传头像"><i class="layui-icon" style="color: #009688"
                                >&#xe67c;</i></a>
                            </div>
                        </div>

                        <!-- 记账面板-->
                        <div class="layui-form" style="float:right; margin-right: 120px;">
                            <div class="layui-form-item">
                                <input type="hidden" name="in_ex_status" value="收">
                                <label class="layui-form-label" for="first-income-category">
                                    一级分类：
                                    <a href="javascript:" class="add-category" title="添加分类">
                                        <i class="layui-icon layui-icon-addition"
                                           style="font-size: 15px; margin: 0"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <select name="first_category_name"
                                            lay-filter="first-income-category" id="first-income-category">
                                        <option>一级分类</option>
                                    </select>
                                </div>

                                <label class="layui-form-label" for="second-income-category">
                                    二级分类：
                                    <a href="javascript:" class="add-category" title="添加分类"><i
                                            class="layui-icon layui-icon-addition"
                                            style="font-size: 15px; margin: 0"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <select name="second_category_name" id="second-income-category">
                                        <option>二级分类</option>
                                    </select>
                                </div>

                                <label class="layui-form-label" for="account-type-income">金融账户：
                                    <a href="javascript:" title="添加金融账户">
                                        <i class="layui-icon layui-icon-addition"
                                           style="font-size: 15px; margin: 0"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <select name="account_type_name" id="account-type-income" class="account-type">
                                        <option>金融账户</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label" for="date-income">
                                    日期时间：
                                    <a><i class="layui-icon" style="font-size: 15px; margin-left: 15px"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <input type="text" class="layui-input date" name="dateConverted"
                                           style="width: 150px" id="date-income">
                                </div>

                                <label class="layui-form-label" for="amount-income">
                                    金额明细：
                                    <a><i class="layui-icon" style="font-size: 15px; margin-left: 15px"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <input type="text" name="amount" id="amount-income" required lay-verify="amount"
                                           placeholder="金额明细" autocomplete="off" class="layui-input amount">
                                </div>

                                <label class="layui-form-label" for="category-template-income">
                                    分类模板：
                                    <a href="javascript:" class="add-category-template" title="添加分类模板">
                                        <i class="layui-icon layui-icon-addition"
                                           style="font-size: 15px; margin: 0"></i></a>
                                </label>
                                <div class="layui-input-inline">
                                    <select name="categoryTemplate"
                                            lay-filter="category-template-income" id="category-template-income">
                                        <option>分类模板</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label" for="remarks-income">备注：
                                    <a><i class="layui-icon"
                                          style="font-size: 15px; margin-left: 15px"></i></a></label>
                                <div class="layui-input-inline" style="width: 380px">
                                    <input type="text" name="remarks" placeholder="备注" autocomplete="off"
                                           class="layui-input" width="380px" lay-verify="remarks" id="remarks-income">
                                </div>

                                <button class="layui-btn" lay-submit lay-filter="addAccountCurrentIncome"
                                        style="margin-left: 26px">立即保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 账目清单-->
        <div id="account-total-list" style="margin-left: 60px; margin-right: 60px">
            <hr style="color: lightgrey" class="line">
            <h3 style="float:left;">
                <b>账目清单</b>
                <b><span th:text="${dateRange}" style="font-size: 15px" id="dateRange"></span></b>
            </h3>
            <div id="in-ex-surplus" style="float: right;">
                总支出
                <span class="amount" style="color: #14ba89">- <span id="monthly-expense"></span>
                    </span>
                <span class="separator">|</span>
                总收入
                <span class="amount" style="color: #f1523a">+ <span id="monthly-income"></span></span>
                <span class="separator">|</span>
                结余
                <span class="amount" style="color:#808080;" id="monthly-balance"></span>
                <span style="color: grey; margin-left: 7px">（单位：元）</span>
            </div>
            <hr style="color: lightgrey; height: 10px" class="line">

            <!-- 条件搜索 -->
            <div id="form-search">
                <div class="layui-form">
                    <div class="layui-form-item">
                        <!-- 月份概览 -->
                        <label class="layui-form-label" for="lay-date">月份概览：</label>
                        <div class="layui-input-inline" style="width: 120px">
                            <input type="text" class="layui-input" autocomplete="off" placeholder="yyyy - mm"
                                   id="lay-date" width="75px">
                        </div>

                        <label class="layui-form-label" for="search-first-category">
                            一级分类：
                        </label>
                        <div class="layui-input-inline">
                            <select name="first_category_name" class="first-category"
                                    id="search-first-category" lay-filter="search-first-category">
                                <option>一级分类</option>
                            </select>
                        </div>

                        <label class="layui-form-label" for="search-second-category">
                            二级分类：
                        </label>
                        <div class="layui-input-inline">
                            <select name="second_category_name" class="second-category"
                                    id="search-second-category">
                                <option>二级分类</option>
                            </select>
                        </div>
                        <label class="layui-form-label" for="search-account-type">金融账户：</label>
                        <div class="layui-input-inline">
                            <select name="account_type_name" class="account-type" id="search-account-type">
                                <option>金融账户</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label" for="search-date">
                            日期时间：
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input date" id="search-date" name="date"
                                   style="width: 120px" autocomplete="off" placeholder="选择日期时间">
                        </div>

                        <label class="layui-form-label" for="search-remarks">备注：
                            <a><i class="layui-icon"
                                  style="font-size: 15px; margin-left: 15px"></i></a></label>
                        <div class="layui-input-inline" style="width: 360px">
                            <input type="text" name="remarks" id="search-remarks" placeholder="备注"
                                   autocomplete="off"
                                   class="layui-input remarks" width="380px" lay-verify="remarks">
                        </div>

                        <button class="layui-btn" lay-submit lay-filter="addAccountCurrent"
                                style="margin-left: 26px">
                            <i class="layui-icon layui-icon-search"></i>
                            确定
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 流水数据表格-->
        <div style="margin-top: -10px;margin-left: 60px; margin-right: 60px">
            <table class="layui-table" id="accountCurrent" lay-filter="accountCurrent"></table>
        </div>
    </div>
</div>

<!-- 设置收支属性，默认支出 -->
<input type="hidden" id="in-ex-status" value="支">
<!-- 父窗口和子窗口传递值 -->
<input type="hidden" id="isTableReload" value="0"/>

<script th:src="@{/layui.js}" charset="utf-8"></script>
<script type="text/html" id="barAccountCurrent">
    <a class="layui-btn layui-btn-sm" lay-event="edit">
        <i class="layui-icon layui-icon-edit"
           style="font-size: 5px"></i>
        编辑
    </a>
    <a class="layui-btn layui-btn-danger layui-btn-sm" lay-event="delete">
        <i class="layui-icon layui-icon-delete"
           style="font-size: 5px"></i>
        删除
    </a>
</script>
<script type="text/javascript">
    //添加账本
    function addAccountBook() {
        layer.open({
            type: 2,
            title: '添加账本',
            skin: 'layui-layer-demo', //加上边框
            area: ['400px', '220px'], //宽高
            content: '/keepAccounts/addAccountBook'
        });
    }

    //layui
    layui.use(['laypage', 'dropdown', 'layer', 'element', 'jquery', 'util', 'upload', 'form', 'table', 'laydate'], function () {
        var element = layui.element;
        var layer = layui.layer;
        var $ = layui.jquery;
        var upload = layui.upload;
        var form = layui.form;
        var table = layui.table;
        var laydate = layui.laydate;
        var laypage = layui.laypage;
        var dropdown = layui.dropdown;

        //渲染账本
        $.ajax({
                url: '/accountBook/accountBookList',
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var layThisName = layThis("");//获取当前账本索引
                    var accountBook = $("#accountBook");//获取账本id
                    var inExStatus = $("#in-ex-status").val();//获取支出属性
                    for (var i = 0; i < data.data.length; i++) {
                        //判断 lay-this 账本索引的位置
                        if (layThisName === data.data[i]) {
                            accountBook.before(
                                '<dd class="layui-this">' +
                                '<a href="javascript:" lay-filter="accountBook">' + data.data[i] +
                                '<i style="margin-right: 35px"></i>' +
                                '</a>' +
                                '</dd>'
                            );
                        } else {
                            accountBook.before(
                                '<dd>' +
                                '<a href="javascript:" lay-filter="accountBook">' + data.data[i] +
                                '<i style="margin-right: 35px"></i>' +
                                '</a>' +
                                '</dd>'
                            );
                        }
                    }
                    element.render(); //刷新渲染
                    renderFormEx(layThisName, inExStatus);//渲染表单数据
                    renderTotalAmount(getDateSubstring()); //渲染账目清单
                    renderTableData(getDateSubstring());//渲染表格数据
                    renderAccountBookHeader();//渲染账本头像
                    renderSearchForm(layThisName, inExStatus);//渲染搜索表单
                }
            }
        );

        //添加模块
        $(document).ready(function () {
            //添加分类
            $(".add-category").click(function () {
                var layThisName = layThis("");//获取账本索引
                var inExStatus = $("#in-ex-status").val();// 获取收支属性
                layer.open({
                    type: 2,
                    title: '添加分类',
                    skin: 'layui-layer-demo', //加上边框
                    area: ['400px', '310px'], //宽高
                    content: '/keepAccounts/addCategory?inExStatus=' + inExStatus,
                    end: function () {
                        //如果子窗口提交成功，那么就执行表单异步更新
                        if (window.localStorage.getItem("isRenderSelect") === "1") {
                            if (inExStatus === "支") {
                                renderFormEx(layThisName, inExStatus);
                            } else {
                                renderFormIn(layThisName, inExStatus);
                            }
                            window.localStorage.setItem("isRenderSelect", "0");
                        }
                    }
                });
            });
            //添加金融账户
            $(".account-type").click(function () {
                var layThisName = layThis("");//获取账本索引
                var inExStatus = $("#in-ex-status").val();// 获取收支属性
                layer.open({
                    type: 2,
                    title: '添加金融账户',
                    skin: 'layui-layer-demo', //加上边框
                    area: ['420px', '210px'], //宽高
                    content: '/keepAccounts/addAccountType',
                    end: function () {
                        if (window.localStorage.getItem("isRenderSelect") === "1") {
                            if (inExStatus === "支") {
                                renderFormEx(layThisName, inExStatus);
                            } else {
                                renderFormIn(layThisName, inExStatus);
                            }
                            window.localStorage.setItem("isRenderSelect", "0");
                        }
                    }
                });
            });
            //添加模板
            $(".add-category-template").click(function () {
                var layThisName = layThis("");//获取账本索引
                var inExStatus = $("#in-ex-status").val();// 获取收支属性
                layer.open({
                    type: 2,
                    title: '添加分类模板',
                    skin: 'layui-layer-demo', //加上边框
                    area: ['580px', '280px'], //宽高
                    content: '/keepAccounts/addCategoryTemplate?inExStatus=' + inExStatus,
                    end: function () {
                        if (window.localStorage.getItem("isRenderSelect") === "1") {
                            if (inExStatus === "支") {
                                renderFormEx(layThisName, inExStatus);
                            } else {
                                renderFormIn(layThisName, inExStatus);
                            }
                            window.localStorage.setItem("isRenderSelect", "0");
                        }
                    }
                });
            });
        });

        //账本头像上传
        upload.render({
            elem: '#accountBookHeader' //绑定元素
            , url: '/accountBookHeader/upload' //上传接口
            , done: function (res) {//上传完毕回调
                $(".accountBookHeaderImg").attr("src", res.data);
                layer.msg(res.msg);
            }
            , error: function (res) {
                //请求异常回调
                layer.msg(res.msg);
            }
        });

        //表单验证
        form.verify({
            remarks: function (value) {
                if (value.length > 50) {
                    return "备注格式太长，受限于50个字符";
                }
            },
            amount: function (value) {
                if (value.trim() === '') {
                    return "请输入金额明细";
                }
            }
        });

        // 设置 lay-this 账本索引
        function layThis(layThisName) {
            var lay_this_name = "";
            $.ajax({
                url: '/layThis/select?layThisName=' + layThisName,
                async: false, //同步
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    lay_this_name = data.layThisName;
                }
            });
            return lay_this_name;
        }

        //渲染账本头像
        function renderAccountBookHeader() {
            $.ajax({
                url: '/accountBookHeader/getHeaderPath',
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    if (data.success) {
                        $(".accountBookHeaderImg").attr("src", data.data);
                    } else {
                        $(".accountBookHeaderImg").attr("src", null);
                    }
                }
            });
        }

        //渲染表单支出数据
        function renderFormEx(accountBookName, inExStatus) {
            //渲染一级分类
            $.ajax({
                url: '/category/firstCategoryList',
                data: {
                    accountBookName: accountBookName,
                    inExStatus: inExStatus
                },
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var f_e_c = $("#first-expense-category");
                    if (data.msg === "操作成功") {
                        f_e_c.empty(); //清空列表 避免重复提交渲染
                        for (var i = 0; i < data.data.length; i++) {
                            f_e_c.append("<option>" + data.data[i] + "</option>");
                        }
                        form.render('select'); //刷新渲染
                        var firstCategoryName = f_e_c.val(); //获取一级分类
                        renderSecondExpenseCategory(firstCategoryName, inExStatus); //渲染二级分类
                    } else {

                    }
                }
            });

            //渲染二级分类
            function renderSecondExpenseCategory(firstCategoryName, inExStatus) {
                var s_e_c = $("#second-expense-category");
                $.ajax({
                    url: '/category/secondCategoryList',
                    data: {
                        firstCategoryName: firstCategoryName,
                        inExStatus: inExStatus
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        if (data.msg === "操作成功") {
                            s_e_c.empty(); //防止重复渲染
                            for (var i = 0; i < data.data.length; i++) {
                                s_e_c.append("<option>" + data.data[i] + "</option>");
                            }
                            form.render('select'); //刷新渲染列表
                        } else {

                        }
                    }
                });
            }

            //渲染金融账户
            $.ajax({
                url: '/accountType/accountType.json?accountBookName=' + accountBookName,
                data: accountBookName,
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var a_t = $("#account-type");
                    if (data.success) {
                        a_t.empty();//防止重复渲染
                        for (var i = 0; i < data.data.length; i++) {
                            a_t.append("<option>" + data.data[i] + "</option>");
                        }
                        form.render('select'); //刷新渲染
                    } else {

                    }
                }
            });

            //渲染日期时间
            $(document).ready(function () {
                var clock = new Clock();

                function Clock() {
                    var date = new Date();
                    this.year = date.getFullYear();
                    this.month = date.getMonth() + 1;
                    this.date = date.getDate();
                    this.hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                    this.minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                    this.second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
                    this.toString = function () {
                        if (this.month < 10) {
                            if (this.date < 10) {
                                return this.year + "-0" + this.month + "-0" + this.date + " " + this.hour + ":" + this.minute + ":" + this.second;
                            }
                            return this.year + "-0" + this.month + "-" + this.date + " " + this.hour + ":" + this.minute + ":" + this.second;
                        } else {
                            if (this.date < 10) {
                                return this.year + "-" + this.month + "-0" + this.date + " " + this.hour + ":" + this.minute + ":" + this.second;
                            }
                            return this.year + "-" + this.month + "-" + this.date + " " + this.hour + ":" + this.minute + ":" + this.second;
                        }
                    };

                    this.display = function (ele) {
                        var clock = new Clock();
                        $("#date").val(clock.toString());
                        window.setTimeout(function () {
                            clock.display(ele);
                        }, 1000);//每秒刷新一次
                    };
                }

                clock.display();
            });

            //渲染分类模板
            $.ajax({
                url: '/categoryTemplate/categoryTemplateList',
                data: {accountBookName: accountBookName, inExStatus: inExStatus},
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var c_t = $("#category-template");
                    if (data.msg === "操作成功") {
                        c_t.empty();
                        for (var i = 0; i < data.data.length; i++) {
                            c_t.append("<option>" + data.data[i] + "</option>")
                        }
                        form.render('select');
                    } else {
                        c_t.empty();
                        c_t.append("<option>分类模板</option>");
                        form.render('select');
                    }
                }
            });
        }

        //渲染表单收入数据
        function renderFormIn(accountBookName, inExStatus) {
            //渲染一级分类
            $.ajax({
                url: '/category/firstCategoryList',
                data: {
                    accountBookName: accountBookName,
                    inExStatus: inExStatus
                },
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var f_e_c = $("#first-income-category");
                    if (data.msg === "操作成功") {
                        f_e_c.empty(); //清空列表 避免重复提交渲染
                        for (var i = 0; i < data.data.length; i++) {
                            f_e_c.append("<option>" + data.data[i] + "</option>");
                        }
                        form.render('select'); //刷新渲染
                        var firstCategoryName = f_e_c.val(); //获取一级分类
                        renderSecondCategory(firstCategoryName, inExStatus); //渲染二级分类
                    } else {

                    }
                }
            });

            //渲染二级分类
            function renderSecondCategory(firstCategoryName, inExStatus) {
                var s_e_c = $("#second-income-category");
                $.ajax({
                    url: '/category/secondCategoryList',
                    data: {
                        firstCategoryName: firstCategoryName,
                        inExStatus: inExStatus
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        if (data.msg === "操作成功") {
                            s_e_c.empty(); //防止重复渲染
                            for (var i = 0; i < data.data.length; i++) {
                                s_e_c.append("<option>" + data.data[i] + "</option>");
                            }
                            form.render('select'); //刷新渲染列表
                        } else {

                        }
                    }
                });
            }

            //渲染金融账户
            $.ajax({
                url: '/accountType/accountType.json?accountBookName=' + accountBookName,
                data: accountBookName,
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var a_t = $("#account-type-income");
                    if (data.success) {
                        a_t.empty();//防止重复渲染
                        for (var i = 0; i < data.data.length; i++) {
                            a_t.append("<option>" + data.data[i] + "</option>");
                        }
                        form.render('select'); //刷新渲染
                    } else {

                    }
                }
            });

            //渲染日期时间
            $(document).ready(function () {
                var clock = new Clock();

                function Clock() {
                    var date = new Date();
                    this.year = date.getFullYear();
                    this.month = date.getMonth() + 1;
                    this.date = date.getDate();
                    this.hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                    this.minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                    this.second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
                    this.toString = function () {
                        if (this.month < 10) {
                            if (this.date < 10) {
                                return this.year + "-0" + this.month + "-0" + this.date + " " + this.hour + ":" + this.minute + ":" + this.second;
                            }
                            return this.year + "-0" + this.month + "-" + this.date + " " + this.hour + ":" + this.minute + ":" + this.second;
                        } else {
                            if (this.date < 10) {
                                return this.year + "-" + this.month + "-0" + this.date + " " + this.hour + ":" + this.minute + ":" + this.second;
                            }
                            return this.year + "-" + this.month + "-" + this.date + " " + this.hour + ":" + this.minute + ":" + this.second;
                        }
                    };

                    this.display = function (ele) {
                        var clock = new Clock();
                        $("#date-income").val(clock.toString());
                        window.setTimeout(function () {
                            clock.display(ele);
                        }, 1000);//每秒刷新一次
                    };
                }

                clock.display();
            });

            //渲染分类模板
            $.ajax({
                url: '/categoryTemplate/categoryTemplateList',
                data: {accountBookName: accountBookName, inExStatus: inExStatus},
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var c_t = $("#category-template-income");
                    if (data.msg === "操作成功") {
                        c_t.empty();
                        for (var i = 0; i < data.data.length; i++) {
                            c_t.append("<option>" + data.data[i] + "</option>")
                        }
                        form.render('select');
                    } else {
                        c_t.empty();
                        c_t.append("<option>分类模板</option>");
                        form.render('select');
                    }
                }
            });
        }

        //渲染表格流水数据
        function renderTableData(dateSubstring) {
            table.render({
                elem: '#accountCurrent',
                url: '/accountCurrent/accountCurrentList.json?dateSubstring=' + dateSubstring, //数据接口
                title: '用户列表',
                height: 472,
                page: true,
                limit: 10,
                limits: [10, 20, 30, 40],
                skin: 'line',
                cols: [
                    [   //表头
                        {field: 'id', hide: true},
                        {field: 'date', hide: true},
                        {field: 'dateConverted', title: '日期', sort: true},
                        {field: 'second_category_name', title: '分类', sort: true},
                        {field: 'in_ex_status', title: '收支', sort: true},
                        {field: 'amountString', title: '金额', sort: true},
                        {field: 'account_type_name', title: '账户', sort: true},
                        {field: 'remarks', title: '备注'},
                        {title: '操作', toolbar: '#barAccountCurrent', width: 200, align: 'center', fixed: 'right'}
                    ]
                ],
                initSort: {field: 'date', type: 'desc'},
                //用于搜索结果重载
                id: 'accountCurrentData',
                done: function (res) { //回调函数
                    //设置账目清单的时间范围
                    $("#dateRange").text(res.dateRange);
                }
            });
        }

        //表格数据重载
        function tableReload() {
            table.reload('accountCurrentData', {
                //重载后以日期排序
                initSort: {field: 'date', type: 'desc'},
                method: 'post',
                page: {
                    curr: 1 //重新从第 1 页开始
                },
                deep: true
            });
        }

        //渲染账目清单
        function renderTotalAmount(dateSubstring) {
            //月收入总额
            $.ajax({
                url: '/totalAmountCalculate/getMonthlyIncome?dateSubstring=' + dateSubstring,
                data: dateSubstring,
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    if (data.success) {
                        $("#monthly-income").text(data.data);
                    }
                }
            });
            //月支出总额
            $.ajax({
                url: '/totalAmountCalculate/getMonthlyExpense?dateSubstring=' + dateSubstring,
                data: dateSubstring,
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    if (data.success) {
                        $("#monthly-expense").text(data.data);
                    }
                }
            });
            //月结余总额
            $.ajax({
                url: '/totalAmountCalculate/getMonthlyBalance?dateSubstring=' + dateSubstring,
                data: dateSubstring,
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    if (data.success) {
                        $("#monthly-balance").text(data.data);
                    }
                }
            });
        }

        //获取当前年份、月份，流水数据日期选择
        function getDateSubstring() {
            var date = new Date;
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            var dateSubstring;
            if (month < 10) {
                dateSubstring = year + '-' + '0' + month;
            } else {
                dateSubstring = year + '-' + month;
            }
            return dateSubstring;
        }

        //渲染条件搜索表单
        function renderSearchForm(accountBookName, inExStatus) {
            //渲染一级分类
            $.ajax({
                url: '/category/firstCategoryAllList?accountBookName=' + accountBookName,
                data: accountBookName,
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var f_c = $("#search-first-category");
                    if (data.msg === "操作成功") {
                        f_c.empty(); //清空列表 避免重复提交渲染
                        for (var i = 0; i < data.data.length; i++) {
                            f_c.append("<option>" + data.data[i] + "</option>");
                        }
                        form.render('select'); //刷新渲染
                        var firstCategoryName = f_c.val(); //获取一级分类
                        renderSecondCategory(firstCategoryName, inExStatus); //渲染二级分类
                    } else {

                    }
                }
            });

            //渲染二级分类
            function renderSecondCategory(firstCategoryName, inExStatus) {
                var s_e_c = $("#search-second-category");
                $.ajax({
                    url: '/category/secondCategoryList',
                    data: {firstCategoryName: firstCategoryName, inExStatus: inExStatus},
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        if (data.msg === "操作成功") {
                            s_e_c.empty(); //防止重复渲染
                            for (var i = 0; i < data.data.length; i++) {
                                s_e_c.append("<option>" + data.data[i] + "</option>");
                            }
                            form.render('select'); //刷新渲染列表
                        } else {

                        }
                    }
                });
            }

            //渲染金融账户
            $.ajax({
                url: '/accountType/accountType.json?accountBookName=' + accountBookName,
                data: accountBookName,
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var a_t = $("#search-account-type");
                    if (data.success) {
                        a_t.empty();//防止重复渲染
                        for (var i = 0; i < data.data.length; i++) {
                            a_t.append("<option>" + data.data[i] + "</option>");
                        }
                        form.render('select'); //刷新渲染
                    } else {

                    }
                }
            });
        }

        //账本事件
        element.on('nav(all)', function (elem) {
            //切换选项卡为支出面板
            element.tabChange('keepAccounts', '支出');
            // var accountBookName = $(this).text().replace(/[ ]/g, ""); //去掉空格
            var accountBookName = elem.text().trim(); //获取当前账本
            var inExStatus = $("#in-ex-status").val("支").val();//获取收支属性
            if (accountBookName !== "所有账本" && accountBookName !== "添加账本") {
                layThis(elem.text().trim());//设置当前 lay-this 账本索引
                renderFormEx(accountBookName, inExStatus); //渲染表单数据
                renderTableData(getDateSubstring());  //渲染流水表格
                renderAccountBookHeader();//渲染账本头像
                renderTotalAmount(getDateSubstring()); //渲染账目清单
                renderSearchForm(accountBookName, inExStatus);//渲染表单搜索
            } else if (accountBookName === "添加账本") {
                addAccountBook();
            } else if (accountBookName === "所有账本") {
                var f_c = $(".first-category").empty().append("<option>一级分类</option>");
                var s_c = $(".second-category").empty().append("<option>二级分类</option>");
                var a_t = $(".account-type").empty().append("<option>金融账户</option>");
                var c_t = $(".category-template").empty().append("<option>分类模板</option>");
                var render = form.render('select');
            }
        });

        //选项卡 切换到收入面板
        element.on('tab(keepAccounts)', function (elem) {
            var accountBookName = layThis("");//获取当前账本索引
            var inExStatus = $("#in-ex-status");//获取收支元素
            if (elem.index === 0) {//当面板切换到支出选项卡时
                inExStatus.val("支");//收支属性设置为：支
            }
            if (elem.index === 1) {//当面板切换到收入选项卡时
                var inExStatusValue = inExStatus.val("收").val();//收支属性设置为：收
                //渲染收入表单数据
                renderFormIn(accountBookName, inExStatusValue);
            }
        });

        //一级支出事件（记账面板选择）
        form.on('select(first_expense_category)', function (data) {
            var inExStatus = $("#in-ex-status").val();//获取支出属性
            var firstCategoryName = data.value;//获取一级分类
            $.ajax({
                url: '/category/secondCategoryList',
                data: {
                    firstCategoryName: firstCategoryName,
                    inExStatus: inExStatus
                },
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var s_e_c = $("#second-expense-category");
                    if (data.msg === "操作成功") {
                        s_e_c.empty(); //防止重复渲染
                        for (var i = 0; i < data.data.length; i++) {
                            s_e_c.append("<option>" + data.data[i] + "</option>");
                        }
                        form.render('select'); //刷新渲染列表
                    } else {
                        layer.msg(data.msg);
                    }
                }
            });
        });

        //一级收入事件（记账面板选择）
        form.on('select(first-income-category)', function (data) {
            var inExStatus = $("#in-ex-status").val();//获取支出属性
            var firstCategoryName = data.value;//获取一级分类
            $.ajax({
                url: '/category/secondCategoryList',
                data: {
                    firstCategoryName: firstCategoryName,
                    inExStatus: inExStatus
                },
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var s_e_c = $("#second-income-category");
                    if (data.msg === "操作成功") {
                        s_e_c.empty(); //防止重复渲染
                        for (var i = 0; i < data.data.length; i++) {
                            s_e_c.append("<option>" + data.data[i] + "</option>");
                        }
                        form.render('select'); //刷新渲染列表
                    } else {
                        layer.msg(data.msg);
                    }
                }
            });
        });

        //一级支出事件（条件搜索表单）
        form.on('select(search-first-category)', function (data) {
            //提交数据 返回后台 查询对应的二级分类
            var firstCategoryName = data.value;
            $.ajax({
                url: '/category/secondCategoryAllList?firstCategoryName=' + firstCategoryName,
                data: firstCategoryName,
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    var s_e_c = $("#search-second-category");
                    if (data.msg === "操作成功") {
                        s_e_c.empty(); //防止重复渲染
                        for (var i = 0; i < data.data.length; i++) {
                            s_e_c.append("<option>" + data.data[i] + "</option>");
                        }
                        form.render('select'); //刷新渲染列表
                    } else {
                        layer.msg(data.msg);
                    }
                }
            });
        });

        //分类模板事件（支出）
        form.on('select(categoryTemplate)', function (data) {
            var categoryTemplateName = data.value; //获取模板名称
            var inExStatus = $("#in-ex-status").val(); //获取收支属性
            //获取模板绑定的数据
            $.ajax({
                url: '/categoryTemplate/categoryTemplateSingle',
                data: {categoryTemplateName: categoryTemplateName, inExStatus: inExStatus},
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    if (data.success) {
                        //渲染一级分类选项
                        $("#first-expense-category").val(data.data[0]);
                        //渲染二级分类选项
                        renderSecondCategory(data.data[0], data.data[1], inExStatus);
                        //渲染金融账户分类选项
                        $("#account-type").val(data.data[2]);
                        form.render('select');
                    } else {

                    }
                }
            });

            //渲染二级分类且渲染选项值
            function renderSecondCategory(firstCategoryName, secondCategoryName, inExStatus) {
                var s_e_c = $("#second-expense-category");
                $.ajax({
                    url: '/category/secondCategoryList',
                    data: {
                        firstCategoryName: firstCategoryName,
                        inExStatus: inExStatus
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        if (data.msg === "操作成功") {
                            s_e_c.empty(); //防止重复渲染
                            for (var i = 0; i < data.data.length; i++) {
                                s_e_c.append("<option>" + data.data[i] + "</option>");
                            }
                            //设置 value 值
                            s_e_c.val(secondCategoryName);
                            form.render('select'); //刷新渲染列表
                        } else {

                        }
                    }
                });
            }
        });

        //分类模板事件（收入）
        form.on('select(category-template-income)', function (data) {
            var categoryTemplateName = data.value; //获取模板名称
            var inExStatus = $("#in-ex-status").val(); //获取收支属性
            //获取模板绑定的数据
            $.ajax({
                url: '/categoryTemplate/categoryTemplateSingle',
                data: {categoryTemplateName: categoryTemplateName, inExStatus: inExStatus},
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    if (data.success) {
                        //渲染一级分类选项
                        $("#first-income-category").val(data.data[0]);
                        //渲染二级分类选项
                        renderSecondCategory(data.data[0], data.data[1], inExStatus);
                        //渲染金融账户分类选项
                        $("#account-type-income").val(data.data[2]);
                        form.render('select');
                    } else {

                    }
                }
            });

            //渲染二级分类且渲染选项值
            function renderSecondCategory(firstCategoryName, secondCategoryName, inExStatus) {
                var s_e_c = $("#second-income-category");
                $.ajax({
                    url: '/category/secondCategoryList',
                    data: {
                        firstCategoryName: firstCategoryName,
                        inExStatus: inExStatus
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        if (data.msg === "操作成功") {
                            s_e_c.empty(); //防止重复渲染
                            for (var i = 0; i < data.data.length; i++) {
                                s_e_c.append("<option>" + data.data[i] + "</option>");
                            }
                            //设置 value 值
                            s_e_c.val(secondCategoryName);
                            form.render('select'); //刷新渲染列表
                        } else {

                        }
                    }
                });
            }
        });

        //表单提交（添加支出流水账单）
        form.on('submit(addAccountCurrent)', function (data) {
            $.ajax({
                url: '/accountCurrent/addAccountCurrent',
                data: data.field,
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    if (data.success) {
                        $("#amount").val("");//清空金额明细
                        $("#remarks").val("");//清空备注
                        //渲染账目清单
                        renderTotalAmount(getDateSubstring());
                        //执行表格数据重载异步更新
                        tableReload();
                    } else {
                        layer.msg(data.message);
                    }
                }
            });
            return false;
        });

        //表单提交（添加收入流水账单）

        form.on('submit(addAccountCurrentIncome)', function (data) {
            $.ajax({
                url: '/accountCurrent/addAccountCurrent',
                data: data.field,
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    if (data.success) {
                        $("#amount").val("");//清空金额明细
                        $("#remarks").val("");//清空备注
                        //渲染账目清单
                        renderTotalAmount(getDateSubstring());
                        //执行表格数据重载异步更新
                        tableReload();
                    } else {
                        layer.msg(data.message);
                    }
                }
            });
            return false;
        });

        //日期选择（查询面板）
        laydate.render({
            elem: '#lay-date',//指定元素
            type: 'month',
            theme: '#393D49',
            done: function (value) {
                //渲染账目清单
                renderTotalAmount(value);
                //查询指定年月的流水数据
                renderTableData(value);
            }
        });

        //日期选择（查询面板）
        laydate.render({
            elem: '#search-date',//指定元素
            type: 'date',
            theme: '#393D49',
            range: true
        });

        //表格监听事件
        table.on('tool(accountCurrent)', function (obj) {
            var data = obj.data; //获取本行流水数据
            var event = obj.event; //获取事件
            if (event === 'edit') {
                editAccountCurrent(data);
            } else if (event === 'delete') {
                layer.confirm('确定要删除该行数据吗？', function (index) {
                    deleteAccountCurrent(data, obj, index);
                });

            }

            //编辑本行流水数据
            function editAccountCurrent(data) {
                /**
                 * 只有当修改数据提交成功后，子页面会设置会通过 ajax 传递 isTableReload 到后台设置为 true，则在关闭子窗口的时候重载表格
                 * 单纯关闭窗口右上角的按钮不会重载表格
                 */
                //编辑模块窗口关闭后表格重载索引
                function getTableReload() {
                    var isTableReload = false;
                    $.ajax({
                        url: '/tableReload/getTableReload',
                        dataType: 'json',
                        async: false, //同步
                        type: 'post',
                        success: function (data) {
                            if (data.success) {
                                isTableReload = data.data;
                            } else {
                                layer.msg(data.msg);
                            }
                        }
                    });
                    return isTableReload;
                }

                //编辑模块窗口关闭后设置表格重载
                function setTableReload(isTableReload) {
                    $.ajax({
                        url: '/tableReload/setTableReload?isTableReload=' + isTableReload,
                        data: isTableReload,
                        dataType: 'json',
                        type: 'post',
                        success: function (data) {
                            if (data.success) {
                                // 获取当前窗口索引
                                var index = parent.layer.getFrameIndex(window.name);
                                // 关闭当前窗口
                                window.parent.layer.close(index);//关闭当前窗口
                            } else {
                                layer.msg(data.msg);
                            }
                        }
                    });
                }

                //编辑流水窗口
                layer.open({
                    type: 2,
                    title: '编辑流水',
                    skin: 'layui-layer-demo', //加上边框
                    area: ['800px', '450px'], //宽高
                    method: 'post',
                    content: '/keepAccounts/editAccountCurrent?accountCurrentId=' + data.id,
                    end: function () {
                        if (getTableReload()) {
                            renderTotalAmount(getDateSubstring());
                            tableReload();//执行表格重载
                            setTableReload(false);
                        }
                    }
                });
            }

            //删除本行流水数据
            function deleteAccountCurrent(data, obj, index) {
                $.ajax({
                    url: '/accountCurrent/delete?accountCurrentId=' + data.id,
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        if (data.success) {
                            obj.del(); //删除对应的行数据
                            layer.close(index);
                            layer.msg(
                                data.message,
                                {time: 1000},
                                function () {
                                    renderTotalAmount(getDateSubstring());
                                    tableReload();
                                }
                            );
                        } else {
                            layer.msg(data.msg);
                        }
                    }
                });
            }
        });
    });
</script>
</body>
</html>
